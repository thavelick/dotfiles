#!/usr/bin/env python3
"""Fetch a URL's title and output a markdown link."""

import argparse
import html.parser
import sys
import urllib.request


class TitleParser(html.parser.HTMLParser):
    def __init__(self):
        super().__init__()
        self._in_title = False
        self._parts = []
        self.title = None

    def handle_starttag(self, tag, attrs):
        if tag.lower() == "title":
            self._in_title = True
            self._parts = []

    def handle_data(self, data):
        if self._in_title:
            self._parts.append(data)

    def handle_endtag(self, tag):
        if tag.lower() == "title" and self._in_title:
            self._in_title = False
            self.title = "".join(self._parts).strip()


def fetch_title(url):
    req = urllib.request.Request(
        url,
        headers={"User-Agent": "Mozilla/5.0 (compatible; mdlink/1.0)"},
    )
    with urllib.request.urlopen(req, timeout=15) as resp:
        charset = resp.headers.get_content_charset() or "utf-8"
        body = resp.read().decode(charset, errors="replace")
    parser = TitleParser()
    parser.feed(body)
    return parser.title


def main():
    ap = argparse.ArgumentParser(description="Output a markdown link for a URL")
    ap.add_argument("url", help="URL to fetch")
    args = ap.parse_args()

    try:
        title = fetch_title(args.url)
    except (ValueError, OSError) as e:
        print(f"mdlink: {e}", file=sys.stderr)
        sys.exit(1)

    title = (title or args.url).replace("[", "\\[").replace("]", "\\]")
    print(f"[{title}]({args.url})")


if __name__ == "__main__":
    main()
