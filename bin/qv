#!/bin/bash
set -e

for cmd in yt-dlp curl llm; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is required but not installed" >&2
        exit 1
    fi
done

if [[ $# -lt 2 ]]; then
    echo "Usage: qv <URL> <question>" >&2
    exit 1
fi

url="$1"
question="$2"

# Fetch the URL content through subtitle extraction
subtitle_url=$(yt-dlp -q --skip-download --convert-subs srt --write-sub --sub-langs "en" --write-auto-sub --print "requested_subtitles.en.url" "$url")
content=$(curl -s "$subtitle_url" | sed '/^$/d' | grep -v '^[0-9]*$' | grep -v '\-->' | sed 's/<[^>]*>//g' | tr '\n' ' ')

# Check if the content was retrieved successfully
if [[ -z "$content" ]]; then
    echo "Failed to retrieve content from the URL." >&2
    exit 1
fi

system="You are a helpful assistant that can answer questions about the video content.
Reply concisely, in a few sentences.

The video transcript:
${content}"

# Use llm with the transcript as a system prompt
llm prompt "$question" -s "$system"
